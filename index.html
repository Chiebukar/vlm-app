<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>SmolVLM Webcam Demo</title>
<style>
  body{font-family:Arial;margin:20px;}
  video{border:1px solid #ccc;border-radius:8px;width:480px;height:360px;}
  textarea{width:480px;height:80px;padding:8px;}
  pre{background:#f4f4f4;padding:10px;border-radius:6px;max-width:480px;white-space:pre-wrap;}
</style>
</head>
<body>
  <h1>SmolVLM Webcam Demo</h1>
  <video id="video" autoplay playsinline></video><br>
  <button id="start">Start</button>
  <button id="stop">Stop</button>
  <div>
    <label>Prompt (what to ask the model):</label><br>
    <textarea id="prompt">What do you see?</textarea>
  </div>
  <h3>Model Response</h3>
  <pre id="response">No response yet</pre>

<script>
const video = document.getElementById('video');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');
const promptEl = document.getElementById('prompt');
const responseEl = document.getElementById('response');
let stream = null;
let intervalId = null;

async function initCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
  }catch(e){
    responseEl.textContent = 'Camera error: ' + e.message;
  }
}

function captureDataURI(){
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 480;
  canvas.height = video.videoHeight || 360;
  canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
  return canvas.toDataURL('image/jpeg', 0.8);
}

async function sendFrame(){
  const prompt = promptEl.value || 'What do you see?';
  const dataURI = captureDataURI();
  if(!dataURI){ responseEl.textContent = 'No frame captured'; return; }

  const payload = {
    max_tokens: 512,
    messages: [
      { role: 'user', content: [
        { type: 'text', text: prompt },
        { type: 'image_url', image_url: { url: dataURI } }
      ] }
    ]
  };

  try{
    const res = await fetch('/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if(!res.ok){
      const txt = await res.text();
      responseEl.textContent = `Server error: ${res.status} ${txt}`;
      return;
    }
    const json = await res.json();
    responseEl.textContent = (json.choices?.[0]?.message?.content) || JSON.stringify(json, null, 2);
  }catch(err){
    responseEl.textContent = 'Fetch error: ' + err.message;
  }
}

startBtn.onclick = () => {
  if (!stream) initCamera();
  if (!intervalId) {
    sendFrame();
    intervalId = setInterval(sendFrame, 2000);
  }
};
stopBtn.onclick = () => {
  if(intervalId) { clearInterval(intervalId); intervalId = null; }
};
window.addEventListener('beforeunload', () => {
  if(stream) stream.getTracks().forEach(t => t.stop());
});
</script>
</body>
</html>
